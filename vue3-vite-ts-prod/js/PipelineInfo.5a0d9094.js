import{_ as e}from"./DialogForm.77d82fc6.js";import{_ as a,a as l,b as t}from"./Search.4da002f7.js";import"./vue.ea117135.js";import{C as i}from"./codeinfoApi.54ff0829.js";import{s as o,a as n}from"./index.f86f8509.js";import{u as s}from"./vuex.16220312.js";import{b as r}from"./vue-router.b3f333f3.js";import{a as d,j as p}from"./element-plus.d9718458.js";import{d as c,Z as u,e as m,j as b,A as f,c as g,U as y,u as v,o as h}from"./@vue.eb62a264.js";import"./Form.c4ec9d19.js";import"./@element-plus.30484454.js";import"./lodash.a57d72c0.js";import"./dayjs.11b573ac.js";import"./axios.5fdf0182.js";import"./universal-cookie.a55469f4.js";import"./mqtt.f77a2428.js";import"./lodash-es.d4f5f48c.js";import"./@vueuse.45c6cd4e.js";import"./@popperjs.b78c3215.js";import"./@ctrl.91de2ec7.js";import"./async-validator.7592c8ba.js";import"./memoize-one.63ab667a.js";import"./normalize-wheel-es.3222b0a2.js";import"./@floating-ui.36fbce82.js";const k="http://123.60.131.126:7001";function j(e){return o({baseURL:k,url:"api/v1/pipeline/add",method:"post",data:e})}function D(e){return o({baseURL:k,url:"api/v1/pipeline/edit",method:"put",data:e})}function _(e){return o({baseURL:k,url:`api/v1/pipeline/delete/${e._id}`,method:"delete"})}function L(e){return o({baseURL:k,url:`api/v1/pipeline/deleteCodeSpace/${e._id}`,method:"delete"})}function B(e={}){return o({baseURL:k,url:`api/v1/pipeline/switchCodeBranch/${e._id}`,method:"patch",data:e})}const w={class:"flex flex-column height-100p"},C=n(c({__name:"PipelineInfo",setup(n){const c=s();r();const{mqttMsg:C}=c.getters,T=u([{type:"input",label:"流水线名称",key:"pipelineName",value:"",placeholder:""},{type:"select",label:"部署环境",key:"deployEnv",value:"",options:[{label:"开发",value:"dev"},{label:"测试",value:"beta"},{label:"生产",value:"prod"}]}]),q=u({page:1,size:10}),O=u([{label:"流水线名称",key:"pipelineName",width:100},{type:"select",label:"部署环境",key:"deployEnv",options:{dev:"开发",beta:"测试",prod:"生产"},width:90},{label:"版本",key:["codeBranch","codeVersion"],width:90},{type:"datetime",label:"部署时间",key:"deployTime"},{label:"部署次数",key:"deployTotal",width:90},{label:"部署状态",key:"runStepName",width:120},{label:"运行时间",key:"runTime",width:90}]),E=u({loading:!1,data:[],selectData:[],page:1,size:10,total:0}),M=u([{type:"success",label:"添加",key:"add"},{type:"primary",label:"编辑",key:"edit"},{type:"primary",label:"切换分支",key:"changeBranch"},{type:"success",label:"部署",key:"deploy"},{type:"danger",label:"删除代码空间",key:"deleteCodeSpace"},{type:"danger",label:"删除",key:"delete"}]),S=u({visible:!1,title:"用户信息",btnType:"",formList:[],formData:{_id:"",codeinfoId:"",pipelineName:"",deployEnv:"",deployMode:"",runCommand:"",deployPosition:"",codeBranch:"",codeVersion:"",codeinfo:{codeManagementTools:""}}}),U=u({formList:[{type:"select",label:"代码信息",key:"codeinfoId",options:[],rules:[{required:!0,message:"不能为空",trigger:["change"]}]},{type:"select",label:"部署环境",key:"deployEnv",options:[{label:"开发",value:"dev"},{label:"测试",value:"beta"},{label:"生产",value:"prod"}],rules:[{required:!0,message:"不能为空",trigger:["change"]}]},{type:"input",label:"流水线名称",key:"pipelineName",rules:[{required:!0,message:"不能为空",trigger:["blur"]}]},{type:"select",label:"部署方式",key:"deployMode",options:[{label:"sftp:部署源文件",value:"sftpDeploy"},{label:"sftp:打包部署dist文件夹",value:"sftpDeployDist"},{label:"部署源文件",value:"sourceFileDeploy"},{label:"打包部署dist文件夹",value:"packDeployDist"},{label:"启动服务",value:"startService"}],rules:[{required:!0,message:"不能为空",trigger:["change"]}]},{type:"inputNoTrim",label:"运行命令",key:"runCommand",rules:[{required:!0,message:"不能为空",trigger:["blur"]}]},{type:"input",label:"部署文件夹",key:"deployPosition",rules:[{required:!0,message:"不能为空",trigger:["blur"]}]}],formData:{codeinfoId:"",pipelineName:"",deployEnv:"",deployMode:"",runCommand:"",deployPosition:""}}),F=u({formList:[{type:"select",label:"代码分支",key:"codeBranch",options:[{label:"trunk",value:"trunk"},{label:"branches",value:"branches"},{label:"tags",value:"tags"}],rules:[{required:!0,message:"不能为空",trigger:["change"]}]},{type:"select",label:"代码版本",key:"codeVersion",options:[],rules:[{required:!0,message:"不能为空",trigger:["change"]}]}],formData:{_id:"",codeBranch:"",codeVersion:""}});m((()=>{var e;return null==(e=S.formData)?void 0:e.deployMode}),(e=>{S.formList.forEach((a=>{"runCommand"==a.key&&(a.hidden=["sftpDeploy","sourceFileDeploy"].includes(e)),"deployPosition"==a.key&&(a.hidden=["startService"].includes(e))}))})),m((()=>{var e;return null==(e=S.formData)?void 0:e.codeBranch}),(()=>{S.visible&&["changeBranch"].includes(S.btnType)&&P()})),m((()=>C.deploy),(e=>{var a;null==(a=E.data)||a.forEach((a=>{a._id==e._id&&Object.assign(a,e)}))})),b((()=>{c.dispatch("MqttTopics",["deploy"]),R()})),f((()=>{c.dispatch("MqttDisTopics",["deploy"])}));const I=e=>{Object.assign(q,e),R(1)},R=(e=E.page,a=E.size)=>{var l;E.loading=!0,(l={...q,page:e,size:a},o({baseURL:k,url:"api/v1/pipeline/list",method:"post",data:l})).then((e=>{Object.assign(E,e.data)})).finally((()=>{E.loading=!1}))},z=async e=>{switch(S.title=null==e?void 0:e.label,S.btnType=null==e?void 0:e.key,S.formList.forEach((e=>e.hidden=!1)),e.key){case"add":Object.assign(S,U),S.visible=!0,N();break;case"edit":if(1!=E.selectData.length)return d.warning("请选择一条数据");Object.assign(S,U),S.visible=!0,N(),Object.assign(S.formData,await $(E.selectData[0]));break;case"delete":case"deleteCodeSpace":Q(e);break;case"changeBranch":if(1!=E.selectData.length)return d.warning("请选择一条数据");Object.assign(S,F),Object.assign(S.formData,await $(E.selectData[0])),S.visible=!0,P();break;case"deploy":A();break;default:d.info("暂未开启，敬请期待")}},P=()=>{var e,a,l,t;let i=null==(a=null==(e=S.formData)?void 0:e.codeinfo)?void 0:a.codeManagementTools;S.formList.forEach((e=>{var a;"codeBranch"==e.key&&(e.hidden=!["svn"].includes(i)),"codeVersion"==e.key&&(e.hidden=["svn"].includes(i)&&["trunk"].includes(null==(a=S.formData)?void 0:a.codeBranch))})),["svn"].includes(i)?!["trunk"].includes(null==(l=S.formData)?void 0:l.codeBranch)&&x(null==(t=S.formData)?void 0:t.codeBranch):x()},x=async(e="")=>{S.formData._id&&function(e={}){return o({baseURL:k,url:`api/v1/pipeline/getCodeBranch/${e._id}`,method:"post",data:e})}({_id:S.formData._id,codeBranch:e}).then((e=>{S.formList.forEach((a=>{var l;"codeVersion"==a.key&&(a.options=null==(l=null==e?void 0:e.data)?void 0:l.map((e=>Object.assign({label:e,value:e}))))}))}))},N=()=>{i({}).then((e=>{var a,l;let t=S.formList.find((e=>"codeinfoId"==(null==e?void 0:e.key)));Object.assign(t,{options:null==(l=null==(a=null==e?void 0:e.data)?void 0:a.data)?void 0:l.map((e=>Object.assign({label:null==e?void 0:e.codeUrl,value:null==e?void 0:e._id})))})}))},V=async e=>{let a={add:j,edit:D,changeBranch:B};e.formData.loading=!0,a[e.btnType](e.formData).then((a=>{e.visible=!1,d.success(a.message),["add"].includes(e.btnType)?R(1):E.data.forEach((async a=>{e.formData._id==a._id&&Object.assign(a,await $(a))}))})).finally((()=>{e.formData.loading=!1}))},$=({_id:e})=>new Promise(((a,l)=>{var t;(t={_id:e},o({baseURL:k,url:`api/v1/pipeline/details/${t._id}`,method:"get"})).then((e=>{a(e.data)}))})),A=()=>{if(0==E.selectData.length)return d.warning("请至少选择一条数据");p.confirm("确定部署吗？","提示",{draggable:!0,beforeClose:(e,a,l)=>{if("confirm"===e)a.confirmButtonLoading=!0,(t={_ids:E.selectData.map((e=>e._id))},o({baseURL:k,url:"api/v1/pipeline/deployMany",method:"patch",data:t})).then((e=>{d.success(e.message)})).finally((()=>{a.confirmButtonLoading=!1,l()}));else l();var t}})},Q=({label:e,key:a})=>{if(1!=E.selectData.length)return d.warning("请选择一条数据");p.confirm(`确定${e}吗？`,"提示",{draggable:!0,beforeClose:(e,l,t)=>{if("confirm"===e){l.confirmButtonLoading=!0,{delete:_,deleteCodeSpace:L}[a]({_id:E.selectData[0]._id}).then((e=>{t(),d.success(e.message),["delete"].includes(a)&&R()})).finally((()=>{l.confirmButtonLoading=!1}))}else t()}})};return(i,o)=>{const n=a,s=l,r=t,d=e;return h(),g("div",w,[y(n,{formList:v(T),tableData:v(E),onQuery:I},null,8,["formList","tableData"]),y(s,{class:"flex-1-1 overflow-auto",btnInfos:v(M),tableList:v(O),tableData:v(E),onClickBtn:z},null,8,["btnInfos","tableList","tableData"]),y(r,{btnInfos:v(M),pagination:v(E),onClickBtn:z,onPage:R,onSize:o[0]||(o[0]=e=>R(1,e))},null,8,["btnInfos","pagination"]),y(d,{dialogForm:v(S),onSubmitForm:V},null,8,["dialogForm"]),y(d,{dialogForm:i.dialogBranch,onSubmitForm:V},null,8,["dialogForm"])])}}}),[["__file","D:/nodejs-egg-template-runningspace/default/666f9cfd3276ef2d39826b3c/src/views/pipelineManagement/PipelineInfo.vue"]]);export{C as default};
