import{P as e,h as a,_ as t,c as l,d as n,e as o,i,j as s,k as d,l as r,m as c}from"./Search-6351c444.js";import{d as b,u as f,k as p,m as y,n as m,p as u,o as g,a as k,b as v,g as h,E as j,l as D}from"./index-b2f21509.js";import"./_plugin-vue_export-helper-1b428a4d.js";const L={class:"flex flex-column h-100p"},I=b({__name:"ProjectDeploy",setup(b){const I=f(),{webSocketInfo:O}=I.getters,w=p([{type:"codeinfo",label:"关联代码",key:"codeinfoIds",value:""},{type:"input",label:"项目名称",key:"projectName",value:""},{type:"envConfig",label:"环境",key:"env",value:""}]),B=p({page:1,size:10}),C=p([{type:"name",label:"项目名称",key:"projectName",width:140},{type:"codeVersion",label:"代码版本",key:"codeVersion",width:90},{type:"envConfig",label:"部署环境",key:"env",width:90},{label:"部署次数",key:"deployNum",width:90},{type:"datetime",label:"部署时间",key:"deployTime"},{type:"duration",label:"运行时长",key:"runDuration",width:90},{label:"运行状态",key:"deployStepName",width:140}]),q=p({loading:!1,data:[],selectData:[],page:1,size:10,total:0}),x=p([{type:"success",label:"添加",key:"add"},{type:"primary",label:"编辑",key:"edit"},{type:"danger",label:"删除",key:"delete"},{type:"info",label:"详情",key:"details"},{type:"primary",label:"部署配置",key:"deployConfig"},{type:"danger",label:"部署",key:"deploy"}]),N=p({visible:!1,btnInfo:{},formList:[],formData:{loading:!1}}),S=p({formList:[{required:!0,type:"codeinfo",label:"关联代码",key:"codeinfoId"},{required:!0,type:"input",label:"项目名称",maxlength:20,key:"projectName"},{required:!0,type:"envConfig",label:"运行环境",key:"env"},{required:!0,type:"input",label:"运行命令",maxlength:20,key:"runCommand"},{required:!0,type:"input",label:"上传文件夹",key:"uploadFolder"}],formData:{loading:!1,id:"",codeinfoId:"",projectName:"",env:"",runCommand:"",uploadFolder:""}}),V=p({formList:[{required:!0,type:"codeinfo",label:"关联代码",key:"codeinfoId",disabled:!0},{required:!0,type:"input",label:"项目名称",maxlength:20,key:"projectName",disabled:!0},{required:!0,type:"select",label:"运行环境",key:"env",disabled:!0,options:[{label:"开发",value:"dev"},{label:"测试",value:"beta"},{label:"生产",value:"production"}]},{required:!0,type:"codeBranch",label:"代码分支",key:"codeBranch",options:[{label:"branches",value:"branches"},{label:"tags",value:"tags"},{label:"trunk",value:"trunk"}]},{required:!0,type:"codeVersion",label:"代码版本",key:"codeVersion"}],formData:{loading:!1,id:"",codeinfoId:"",projectName:"",env:"",codeBranch:"",codeVersion:""}});y((()=>{var e;return(null==(e=null==O?void 0:O.deploy)?void 0:e.message)||""}),(e=>{var a;null==(a=q.data)||a.forEach((a=>{a.id==e.id&&Object.assign(a,e)}))})),m((()=>{I.dispatch("WebSocket","deploy")})),u((()=>{var e;null==(e=O.deploy.ws)||e.close()}));const z=e=>{Object.assign(B,e),F()},F=(a=q.page,t=q.size)=>{q.loading=!0,e({...B,page:a,size:t}).then((e=>{Object.assign(q,e.data)})).catch((e=>{j.error(e.msg)})).finally((()=>{q.loading=!1}))},_=async e=>{switch(N.formList.length=0,e.key){case"add":Object.assign(N.formList,S.formList),Object.assign(N.formData,S.formData),Object.assign(N.btnInfo,e),N.visible=!0;break;case"edit":case"details":Object.assign(N.formList,S.formList),Object.assign(N.formData,S.formData),Object.assign(N.btnInfo,e),E().then((()=>{N.visible=!0}));break;case"delete":Q("确定删除吗?",s);break;case"deploy":Q("确定部署吗?",i);break;case"deployConfig":Object.assign(N.formList,V.formList),Object.assign(N.formData,V.formData),Object.assign(N.btnInfo,e),E().then((e=>{N.formList.forEach((a=>{var t,l;"codeBranch"==a.type&&Object.assign(a,{hidden:"codeBranch"!=a.type||"codeBranch"==a.type&&"svn"!=(null==(t=null==e?void 0:e.codeinfoDetails)?void 0:t.svnorgit)}),"codeVersion"==a.type&&Object.assign(a,{hidden:"svn"==(null==(l=null==e?void 0:e.codeinfoDetails)?void 0:l.svnorgit)&&(!e.codeBranch||"trunk"==e.codeBranch)})})),N.visible=!0}));break;default:j.info("暂未开启")}},E=()=>new Promise(((e,t)=>{if(1!=q.selectData.length)return j.warning("请选择一条数据"),t();N.formData.loading=!0,a({id:q.selectData[0].id}).then((a=>{Object.assign(N.formData,a.data),q.data.forEach((e=>{e.id==q.selectData[0].id&&Object.assign(e,a.data)})),e(a.data)})).finally((()=>{N.formData.loading=!1,t()}))})),P=e=>{let a={add:d,edit:r,deployConfig:c};N.formData.loading=!0,a[e.btnInfo.key](e.formData).then((a=>{N.visible=!1,j.success(a.msg),["add"].includes(e.btnInfo.key)?F():E()})).finally((()=>{N.formData.loading=!1}))},Q=(e,a)=>{if(!q.selectData.length)return j.warning("请至少选择一条数据");D.confirm(e,"提示",{draggable:!0,beforeClose:(e,t,l)=>{if("confirm"===e)t.confirmButtonLoading=!0,a({ids:q.selectData.map((e=>e.id))}).then((e=>{l(),j.success(e.msg),F()})).finally((()=>{t.confirmButtonLoading=!1}));else l()}})};return(e,a)=>{const i=t,s=l,d=n,r=o;return g(),k("div",L,[v(i,{formList:h(w),onQuery:z},null,8,["formList"]),v(s,{class:"flex-1-1 overflow-auto",btnInfos:h(x),tableList:h(C),tableData:h(q),onClickBtn:_},null,8,["btnInfos","tableList","tableData"]),v(d,{btnInfos:h(x),pagination:h(q),onClickBtn:_,onPage:F,onSize:a[0]||(a[0]=e=>F(1,e))},null,8,["btnInfos","pagination"]),v(r,{dialogForm:h(N),onSubmitForm:P},null,8,["dialogForm"])])}}});export{I as default};
