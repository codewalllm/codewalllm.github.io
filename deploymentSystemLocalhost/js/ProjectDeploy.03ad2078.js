import{P as e,h as a,_ as t,c as o,d as i,e as l,i as n,j as s,k as r,l as d,m as c}from"./Search.169d6ddf.js";import{u as p}from"./vuex.1b7a4305.js";import{E as m,a as b}from"./element-plus.68ef0b35.js";import{d as f,Z as u,f as y,i as g,z as v,o as j,c as h,U as k,u as D}from"./@vue.d99a4689.js";import"./vue-router.25eb8d08.js";import"./axios.b084b850.js";import"./index.48d85e0e.js";import"./lodash-es.d4f5f48c.js";import"./@vueuse.694ded36.js";import"./@element-plus.a15d8bac.js";import"./@popperjs.b78c3215.js";import"./@ctrl.91de2ec7.js";import"./dayjs.c6ebfc70.js";import"./async-validator.8d480e59.js";import"./memoize-one.63ab667a.js";import"./normalize-wheel-es.3222b0a2.js";import"./@floating-ui.3c499e77.js";import"./_plugin-vue_export-helper.1b428a4d.js";const L={class:"flex flex-column h-100p"},I=f({__name:"ProjectDeploy",setup(f){const I=p(),{webSocketInfo:O}=I.getters,w=u([{type:"codeinfo",label:"关联代码",key:"codeinfoIds",value:""},{type:"input",label:"项目名称",key:"projectName",value:""},{type:"envConfig",label:"环境",key:"env",value:""}]),B=u({page:1,size:10}),x=u([{type:"name",label:"项目名称",key:"projectName",width:140},{type:"codeVersion",label:"代码版本",key:"codeVersion",width:90},{type:"envConfig",label:"部署环境",key:"env",width:90},{label:"部署次数",key:"deployNum",width:90},{type:"datetime",label:"部署时间",key:"deployTime"},{type:"duration",label:"运行时长",key:"runDuration",width:90},{label:"运行状态",key:"deployStepName",width:140}]),C=u({loading:!1,data:[],selectData:[],page:1,size:10,total:0}),q=u([{type:"success",label:"添加",key:"add"},{type:"primary",label:"编辑",key:"edit"},{type:"danger",label:"删除",key:"delete"},{type:"info",label:"详情",key:"details"},{type:"primary",label:"部署配置",key:"deployConfig"},{type:"danger",label:"部署",key:"deploy"}]),z=u({visible:!1,btnInfo:{},formList:[],formData:{loading:!1}}),N=u({formList:[{required:!0,type:"codeinfo",label:"关联代码",key:"codeinfoId"},{required:!0,type:"input",label:"项目名称",maxlength:20,key:"projectName"},{required:!0,type:"envConfig",label:"运行环境",key:"env"},{required:!0,type:"input",label:"运行命令",maxlength:20,key:"runCommand"},{required:!0,type:"input",label:"上传文件夹",key:"uploadFolder"}],formData:{loading:!1,id:"",codeinfoId:"",projectName:"",env:"",runCommand:"",uploadFolder:""}}),S=u({formList:[{required:!0,type:"codeinfo",label:"关联代码",key:"codeinfoId",disabled:!0},{required:!0,type:"input",label:"项目名称",maxlength:20,key:"projectName",disabled:!0},{required:!0,type:"select",label:"运行环境",key:"env",disabled:!0,options:[{label:"开发",value:"dev"},{label:"测试",value:"beta"},{label:"生产",value:"production"}]},{required:!0,type:"codeBranch",label:"代码分支",key:"codeBranch",options:[{label:"branches",value:"branches"},{label:"tags",value:"tags"},{label:"trunk",value:"trunk"}]},{required:!0,type:"codeVersion",label:"代码版本",key:"codeVersion"}],formData:{loading:!1,id:"",codeinfoId:"",projectName:"",env:"",codeBranch:"",codeVersion:""}});y((()=>{var e;return(null==(e=null==O?void 0:O.deploy)?void 0:e.message)||""}),(e=>{var a;null==(a=C.data)||a.forEach((a=>{a.id==e.id&&Object.assign(a,e)}))})),g((()=>{I.dispatch("WebSocket","deploy")})),v((()=>{var e;null==(e=O.deploy.ws)||e.close()}));const V=e=>{Object.assign(B,e),F()},F=(a=C.page,t=C.size)=>{C.loading=!0,e({...B,page:a,size:t}).then((e=>{Object.assign(C,e.data)})).catch((e=>{m.error(e.msg)})).finally((()=>{C.loading=!1}))},_=async e=>{switch(z.formList.length=0,e.key){case"add":Object.assign(z.formList,N.formList),Object.assign(z.formData,N.formData),Object.assign(z.btnInfo,e),z.visible=!0;break;case"edit":case"details":Object.assign(z.formList,N.formList),Object.assign(z.formData,N.formData),Object.assign(z.btnInfo,e),E().then((()=>{z.visible=!0}));break;case"delete":Q("确定删除吗?",s);break;case"deploy":Q("确定部署吗?",n);break;case"deployConfig":Object.assign(z.formList,S.formList),Object.assign(z.formData,S.formData),Object.assign(z.btnInfo,e),E().then((e=>{z.formList.forEach((a=>{var t,o;"codeBranch"==a.type&&Object.assign(a,{hidden:"codeBranch"!=a.type||"codeBranch"==a.type&&"svn"!=(null==(t=null==e?void 0:e.codeinfoDetails)?void 0:t.svnorgit)}),"codeVersion"==a.type&&Object.assign(a,{hidden:"svn"==(null==(o=null==e?void 0:e.codeinfoDetails)?void 0:o.svnorgit)&&(!e.codeBranch||"trunk"==e.codeBranch)})})),z.visible=!0}));break;default:m.info("暂未开启")}},E=()=>new Promise(((e,t)=>{if(1!=C.selectData.length)return m.warning("请选择一条数据"),t();z.formData.loading=!0,a({id:C.selectData[0].id}).then((a=>{Object.assign(z.formData,a.data),C.data.forEach((e=>{e.id==C.selectData[0].id&&Object.assign(e,a.data)})),e(a.data)})).finally((()=>{z.formData.loading=!1,t()}))})),P=e=>{let a={add:r,edit:d,deployConfig:c};z.formData.loading=!0,a[e.btnInfo.key](e.formData).then((a=>{z.visible=!1,m.success(a.msg),["add"].includes(e.btnInfo.key)?F():E()})).finally((()=>{z.formData.loading=!1}))},Q=(e,a)=>{if(!C.selectData.length)return m.warning("请至少选择一条数据");b.confirm(e,"提示",{draggable:!0,beforeClose:(e,t,o)=>{if("confirm"===e)t.confirmButtonLoading=!0,a({ids:C.selectData.map((e=>e.id))}).then((e=>{o(),m.success(e.msg),F()})).finally((()=>{t.confirmButtonLoading=!1}));else o()}})};return(e,a)=>{const n=t,s=o,r=i,d=l;return j(),h("div",L,[k(n,{formList:D(w),onQuery:V},null,8,["formList"]),k(s,{class:"flex-1-1 overflow-auto",btnInfos:D(q),tableList:D(x),tableData:D(C),onClickBtn:_},null,8,["btnInfos","tableList","tableData"]),k(r,{btnInfos:D(q),pagination:D(C),onClickBtn:_,onPage:F,onSize:a[0]||(a[0]=e=>F(1,e))},null,8,["btnInfos","pagination"]),k(d,{dialogForm:D(z),onSubmitForm:P},null,8,["dialogForm"])])}}});export{I as default};
