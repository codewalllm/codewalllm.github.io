<!DOCTYPE html>
<html lang="en" style="width: 100%;height: 100%;margin: 0;padding: 0;overflow: hidden;">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <title>漫游</title>
    <!-- 核心引擎（必须引用） -->
    <link href="http://60.30.241.14:2650/bimjs/tkengines/tkgis/v0.9.4/Widgets/widgets.css" rel="stylesheet" />
    <script src="http://60.30.241.14:2650/bimjs/tkengines/tkgis/v0.9.4/TkEngine.js"></script>
    <!-- 引擎插件（必须引用） -->
    <script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/plugin/three.min.js"></script>
    <!-- 提供对外bim功能接口（必须引用）-->
    <script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/tkbim.js"></script>
    <script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/tkbimsdk.js"></script>
    <!-- jquery 引擎操作工具（必须引用）-->
    <script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/plugin/jquery-3.4.1.min.js"></script>
</head>

<body style="width: 100%;height: 100%;margin: 0;padding: 0;overflow: hidden;">
    <!-- 引擎渲染容器 -->
    <div id="tkEngineContainer" style="width: 100%;height: 100%;margin: 0;padding: 0;overflow: hidden;"></div>
    <div
        style="background-color: rgba(39, 39, 39, 0.7);position: absolute;z-index: 10;top: 10px;left: 5px;display: flex;flex-direction: column;align-items: center;justify-content: space-around;color: white;border-radius: 5px;padding: 5px;">
        <button type="button" onclick="roamingStart()">开始漫游</button>
        <button type="button" id="viewStatus" onclick="changeRoamingView(!RoamingView)" style="margin-top: 10px;">切换</button>
        <div style="display: flex;align-items: center;margin-top: 10px;">
            <span style="flex: 1;font-size: 13px;">修改漫游速度</span>
            <input type="number" min="0" max="15" value="2" onchange="TKBimSdk.Roaming.setSpeed(value)" style="width: 50px;">
        </div>
        <button type="button" onclick="roamingStatus(true,roamConfig.forwardDir)" style="margin-top: 10px;">开启重力</button>
        <button type="button" onclick="roamingStatus(false,roamConfig.forwardDir)" style="margin-top: 10px;">关闭重力</button>
        <button type="button" onclick="roamingStatus(roamConfig.isGravity,true)" style="margin-top: 10px;">正向</button>
        <button type="button" onclick="roamingStatus(roamConfig.isGravity,false)" style="margin-top: 10px;">反向</button>
        <button type="button" onclick="TKBimSdk.Roaming.end()" style="margin-top: 10px;">结束漫游</button>
    </div>
</body>

<script>
    //加载场景
    TKBimSdk.Scene.loadScene(sessionStorage.getItem("token"), {
        isBimViewMode: false,
        controls: {
            visibleCube: false, //是否显示操作器,默认true,非必要 
            visibleFPS: false, //是否显示帧率,默认true,非必要  
        }
    });
    //模型参数配置
    var model = {
        baseDomain: "https://tkbim-dataserver.tfhulian.com:2627", // BIM模型数据接口服务域名地址
        projectId: "bd425ebdc86b457992a99471fd67ddae",//项目id
        viewId: "0e60c8f535b245de824f6dacf07ae5b9",//模型viewId
        modelCenter: { longitude: 117.24249519270747, latitude: 39.080722698745542, altitude: 3 }, //模型中心点坐标：{经度,纬度,高程}
        viewRatio: 50, //模型可视距离系数
    };
    // 添加模型（可在加载场景之前添加模型，此时添加模型的callback回调不起作用）
    TKBimSdk.TK3DTileset.add3DTiles_Bim(model, (viewId) => {
        //添加模型的回调方法
        TKBimSdk.TK3DTileset.setCollect([viewId], true); //设置模型组同时移动到模型位置
    });
    // 漫游参数配置 - 第一人称漫游
    let roamConfig = {
        speed: 2,//漫游速度（建议0-15之间）
        isGravity: false,//是否开启重力
        forwardDir: true, //操作方向,true正向,false反向
        viewType: {//漫游视角参数
            isFirstPerson: true,//是否第一人称视角
            scope: 1, //第一人称下的视角扩展系数，默认1，可不设
            sightHeight: 2, //第一人称视角下视线高度
            barrierHeight: 1.5, //可越过的障碍物（模型）高度
            modelUrl: null, //第三人称视角模型路径地址
            coordinate: null,//起始漫游点坐标（笛卡尔坐标/经纬度坐标）,默认使用当前镜头坐标
        }
    }
    // 漫游视角
    let RoamingView = roamConfig.viewType.isFirstPerson;
    // 按钮名字
    viewStatus()
    function viewStatus() {
        $("#viewStatus").text(RoamingView ? "切换至第三人称视角" : "切换至第一人称视角");
    }
    // 开始漫游
    function roamingStart() {
        RoamingView = roamConfig.viewType.isFirstPerson;
        viewStatus()
        TKBimSdk.Roaming.start(roamConfig)
    }
    // 切换漫游视角
    function changeRoamingView(view) {
        // 在漫游状态下可以调整
        if (TKBimSdk.Scene.getOperationStatus() != 3) {
            alert("请先开始漫游");
            return;
        };
        RoamingView = view;
        viewStatus();
        let viewConfig = {
            isFirstPerson: view,//是否第一人称视角
            sightHeight: roamConfig.viewType.sightHeight,//可越过的障碍物（模型）高度
            barrierHeight: roamConfig.viewType.barrierHeight,//第一人称视角下视线高度
            modelUrl: view ? '' : "http://cimyanshi.tfhulian.com:7285/apidemonstration/data/models/Person.gltf", //第三人称视角模型路径地址
            coordinate: TKBimSdk.Roaming.getLocation(), // 添加标点的坐标(笛卡尔坐标/经纬度坐标)
        }
        TKBimSdk.Roaming.setView(viewConfig)
    }
    // 漫游状态 - 重力、操作方向
    function roamingStatus(isGravity, forwardDir) {
        roamConfig.isGravity = isGravity;
        roamConfig.forwardDir = forwardDir;
        TKBimSdk.Roaming.setStauts(isGravity, forwardDir)
    }
</script>

</html>
