<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden">

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport"
		content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
	<title>添加标记</title>


	<!-- 核心引擎（必须引用） -->
	<link href="http://60.30.241.14:2650/bimjs/tkengines/tkgis/v0.9.4/Widgets/widgets.css" rel="stylesheet" />
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkgis/v0.9.4/TkEngine.js"></script>

	<!-- 引擎插件（必须引用） -->
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/plugin/three.min.js"></script>
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/plugin/jquery-3.4.1.min.js"></script>



	<!-- 提供对外bim功能接口（必须引用）-->
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/tkbim.js"></script>
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/tkbimsdk.js"></script>
</head>

<body style="width: 100%;height: 100%;margin: 0;padding: 0;overflow: hidden;">
	<div id="tkEngineContainer" style="width: 100%;height: 100%;margin: 0;padding: 0;overflow: hidden;"></div>
	<div class="bottomStyle" id="leftBottomStyle">
		<span id="loadChange"></span>
	</div>

	<div
		style="border-radius: 5px;padding: 5px; background-color: rgba(39, 39, 39, 0.7);position: absolute;z-index: 10;top: 10px;left: 5px;">
		<div class="row">
			<div class="col-md-4">
				<button type="button" onclick="addMarkers()">添加标点</button>
			</div>
			<div class="col-md-4">
				<button type="button" onclick="setMarkersImg()">设置图标</button>
			</div>
			<div class="col-md-4">
				<button type="button" onclick="removeMarkers">删除所有</button>
			</div>
		</div>
		<div class="row">
			<table border="1" id="markertable" style="margin: 10px;margin-left: 15px;width: 280px;">
				<tr>
					<th width="40%">Id</th>
					<th width="60%">操作</th>
				</tr>
			</table>
		</div>
	</div>

</body>

<script>
	//模型配置
	let model = {
		projectId: "bd425ebdc86b457992a99471fd67ddae", //项目id
		viewId: "0e60c8f535b245de824f6dacf07ae5b9", //模型viewId
		modelCenter: {
			longitude: 117.24249519270747,
			latitude: 39.080722698745542,
			altitude: 3,
		}, //模型中心点坐标：{经度,纬度,高程}
		viewRatio: 50, //模型可视距离系数
	};

	//场景配置
	let sceneOptions = {
		isBimViewMode: true, //是否BIM模式加载(false:GIS模式，true:BIM模式，默认true),非必填。
		isModelsCenter: true, //设置模型场景下的旋转中心( true：以模型为中心,false：以GIS场景为中心，默认false),非必填。
		isTransparentOfDis: 50, //相机与选中构件透明化大距离，默认50米，设置为0则相机与构件中间始终透明,非必要。
		controls: {
			visibleCube: true, //是否显示操作器,默认true,非必填
			visibleFPS: true, //是否显示帧率,默认true,非必填
		},
	};

	let bimCallbacks = {
		sceneInitedCb: () => {
			//设置模型集合
			TKBimSdk.TK3DTileset.setCollect([model.viewId], true);
		},
		//左键点击
		onMouseLeftClickCb: (data) => { },
		//右键点击
		onMouseRightClick: (data) => { },
		//左键拖拽
		onMouseLeftDraggingCb: () => { },
		//滚轮滚动事件
		onMouseWheelCb: () => { },
		//框选构件回调
		onBoxChooseCb: (viewIds) => { },

		//当前模型剩余Tileset文件数量（num：剩余Tileset文件数量）
		onTilesetLoadingCb: (num) => {
			if (num === 0) {
				$("#loadChange").text("加载完毕");
			} else {
				$("#loadChange").text("剩余数量:" + num);
			}
		},
	};

	//添加模型
	TKBimSdk.TK3DTileset.add3DTiles_Bim(model);
	// 初始化场景
	TKBimSdk.Scene.loadScene(sessionStorage.getItem("token"), sceneOptions, bimCallbacks);


	let lastMarkerId = undefined;
	let markerLabel = `<div id="label" border="1" name="labelmarker" style="z-index:50;top:0px;left: 0px;position: absolute;background-color: rgba(39, 39, 39, 0.8);padding: 5px;color:white;">
		<span>markername</span>
		<table border="1">
			<tr>
				<th>高度</th>
				<th>宽度</th>
			</tr>
			<tr>
				<td>1.3米</td>
				<td>1.1米</td>
			</tr>
		</table>
	</div>`;

	let markers = [
		{
			id: `marker_1`, //标点id
			coordinate: {
				x: -2269418.3533210475, y: 4407776.629498126, z: 3999273.1928905044,
			},// 添加标点的坐标(笛卡尔坐标/经纬度坐标)
			imgData: { img: "./img/3286991.png", width: 48, height: 48 }, //标点图标属性,非必要,默认使用系统图片，32x32,非必要
			msgData: { msg: `标点1`, font: "20px sans-serif", color: [255, 0, 0, 1] }, //标点文字标注,非必要,默认无文字信息
			alwaysShow: false, //是否是保持显示（不被三维中的物体遮挡）,默认false，非必要
		},
		{
			id: `marker_2`, //标点id
			coordinate: {
				x: -2269415.173651766, y: 4407764.3182024965, z: 3999287.870048253,
			},// 添加标点的坐标(笛卡尔坐标/经纬度坐标)      
			msgData: { msg: `标点2`, font: "20px sans-serif", color: [255, 0, 0, 1] }, //标点文字标注,非必要,默认无文字信息
			alwaysShow: true, //是否是保持显示（不被三维中的物体遮挡）,默认false，非必要
		},
	];


	// 添加标点
	function addMarkers() {
		for (let index = 0; index < markers.length; index++) {
			let marker = markers[index];
			TKBimSdk.Marker.addMarker(marker, markerClickCallBack);

			let tr = `<tr style="font-size: 9px;" id="_${marker.id}">
					<td>${marker.id}</td>
					<td>
            <a href="#" onclick="locationMarker('${marker.id}')">定位</a>
						<a href="#" onclick="deleteMarker('${marker.id}')">删除</a>
					</td>
				</tr>`;
			$("#markertable").append(tr);
		}
	}

	function locationMarker(markerId) {
		TKBimSdk.Marker.locationTo(markerId);
	}
	function deleteMarker(markerId) {
		console.log("deleteMarker", markerId)
		TKBimSdk.Marker.remove(markerId);

		$("#_" + markerId).remove();
		$("#label" + markerId).remove();
	}

	function setMarkersImg() {
		for (let index = 0; index < markers.length; index++) {
			let marker = markers[index];
			TKBimSdk.Marker.setMarkerImg(marker.id, "./img/1161297.png")
		}
	}

	function removeMarkers() {
		TKBimSdk.Marker.removeAll();

		for (let index = 0; index < markers.length; index++) {
			let marker = markers[index];
			$("#_" + marker.id).remove();
			$("#label" + marker.id).remove();
		}
	}


	//标点点击回调
	function markerClickCallBack(markerId) {
		if (lastMarkerId) {
			$("#label" + lastMarkerId).remove();

			//移除标点点击回调
			TKBimSdk.Marker.removeLocationListener(lastMarkerId);
		}

		lastMarkerId = markerId;

		let newlabel = markerLabel.replace("label", "label" + markerId);
		newlabel = newlabel.replace("markername", "标点" + markerId);
		$("#tkEngineContainer").append(newlabel);

		//注册标点点击回调
		TKBimSdk.Marker.addLocationListener(markerId, locationCallBack)
	}


	//标点屏幕坐标回调
	function locationCallBack(data) {
		if (data !== undefined) {
			console.log("markerlocation", data);

			let dom = $("#label" + lastMarkerId);
			let height = dom.height() * 1.6;
			let top = data.y - height;
			let left = data.x; // - width;

			dom.css("top", top);
			dom.css("left", left);
		}
	}

</script>

</html>