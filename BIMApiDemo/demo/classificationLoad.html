<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden">

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport"
		content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
	<title>加载空间标注</title>


	<!-- 核心引擎（必须引用） -->
	<link href="http://60.30.241.14:2650/bimjs/tkengines/tkgis/v0.9.4/Widgets/widgets.css" rel="stylesheet" />
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkgis/v0.9.4/TkEngine.js"></script>

	<!-- 引擎插件（必须引用） -->
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/plugin/three.min.js"></script>
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/plugin/jquery-3.4.1.min.js"></script>
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/plugin/html2canvas.min.js"></script>



	<script src="../../web/libs/layer/layer.min.js"></script>

	<!-- 提供对外bim功能接口（必须引用）-->
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/tkbim.js"></script>
	<script src="http://60.30.241.14:2650/bimjs/tkengines/tkbim/v0.9.4/tkbimsdk.js"></script>
</head>

<body style="width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden">
	<!-- 引擎渲染容器 -->
	<div id="tkEngineContainer" style="width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden"></div>

	<div class="bottomStyle" id="leftBottomStyle">
		<span id="loadChange"></span>
	</div>

	<div
		style="border-radius: 5px;padding: 5px; background-color: rgba(39, 39, 39, 0.7);position: absolute;z-index: 10;top: 10px;left: 5px;display: flex;flex-direction: column;align-items: center;">
		<!-- <img style="width: 20px" src="../img/楼层平面 - F1.png" alt="" /> -->
		<button type="button" onclick="loadClassification()">
			加载
		</button>
		<button type="button" onclick="visibleClassification(true)" style="margin-top: 10px">
			显示所有
		</button>
		<button type="button" onclick="visibleClassification(false)" style="margin-top: 10px">
			移除所有
		</button>
	</div>

	<div style="border-radius: 5px;padding: 5px; background-color: rgba(39, 39, 39, 0.7);position: absolute;z-index: 10;top: 10px;left: 100px;display: flex;flex-direction: column;align-items: center;display: none;"
		id="info">
		<div class="row">
			<table border="1" id="infotable" style="margin: 10px;margin-left: 15px;width: 280px;">
				<tr>
					<th width="40%">Id</th>
					<th width="60%">操作</th>
				</tr>
			</table>
		</div>
	</div>

</body>

<script>

	//模型配置
	let model = {
		projectId: "bd425ebdc86b457992a99471fd67ddae", //项目id
		viewId: "0e60c8f535b245de824f6dacf07ae5b9", //模型viewId
		modelCenter: {
			longitude: 117.24249519270747,
			latitude: 39.080722698745542,
			altitude: 3,
		}, //模型中心点坐标：{经度,纬度,高程}
		viewRatio: 50, //模型可视距离系数
	};

	//场景配置
	let sceneOptions = {
		isBimViewMode: true, //是否BIM模式加载(false:GIS模式，true:BIM模式，默认true),非必填。
		isModelsCenter: true, //设置模型场景下的旋转中心( true：以模型为中心,false：以GIS场景为中心，默认false),非必填。
		isTransparentOfDis: 50, //相机与选中构件透明化大距离，默认50米，设置为0则相机与构件中间始终透明,非必要。
		controls: {
			visibleCube: true, //是否显示操作器,默认true,非必填
			visibleFPS: false, //是否显示帧率,默认true,非必填
		},
	};

	let bimCallbacks = {
		sceneInitedCb: () => {
			//设置模型集合
			TKBimSdk.TK3DTileset.setCollect([model.viewId], true);
		},
		//左键点击
		onMouseLeftClickCb: (data) => {
		},
		//右键点击
		onMouseRightClick: (data) => { },
		//左键拖拽
		onMouseLeftDraggingCb: () => { },
		//滚轮滚动事件
		onMouseWheelCb: () => { },
		//框选构件回调
		onBoxChooseCb: (viewIds) => { },

		//当前模型剩余Tileset文件数量（num：剩余Tileset文件数量）
		onTilesetLoadingCb: (num) => {
			if (num === 0) {
				$("#loadChange").text("加载完毕");
			} else {
				$("#loadChange").text("剩余数量:" + num);
			}
		},
	};

	//添加模型
	TKBimSdk.TK3DTileset.add3DTiles_Bim(model);
	// 初始化场景
	TKBimSdk.Scene.loadScene(sessionStorage.getItem("token"), sceneOptions, bimCallbacks);

	//加载空间标注
	function loadClassification() {
		//加载
		TKBimSdk.Classification.load(classificationData);

		//注册空间标注点击回调
		TKBimSdk.Classification.addClickCallback(classificationClick);

		for (let index = 0; index < classificationData.length; index++) {
			let data = classificationData[index];
			let tr = `<tr style="font-size: 9px;" id="_${data.id}">
					<td>${data.id}</td>
					<td>
            <a href="#" onclick="locationTo('${data.id}')">定位</a>
						<a href="#" onclick="hide('${data.id}')">隐藏</a>
            <a href="#" onclick="show('${data.id}')">显示</a>
					</td>
				</tr>`;
			$("#infotable").append(tr);
		}
		$("#info").show();
	}

	//显示/隐藏空间标注
	function visibleClassification(isVisible) {
		if (isVisible === true) {
			showAll();
		} else {
			removeAll();
		}
	}

	//显示所有
	function showAll() {
		for (let index = 0; index < classificationData.length; index++) {
			let data = classificationData[index];
			let color = randomColor(0.7);

			TKBimSdk.Classification.show({
				id: data.id, //空间信息id
				floor: 1, //要显示第几层,默认1,非必要
				color: color, //颜色值[r,g,b,a],默认[255,0,0,1],非必要
				isShowBox: true, //是否显示图形外观，默认true,非必要
			});
		}
	}

	//根据id显示
	function show(id) {
		TKBimSdk.Classification.show({
			id: id, //空间信息id
			floor: 1, //要显示第几层,默认1,非必要
			color: randomColor(0.7), //颜色值[r,g,b,a],默认[255,0,0,1],非必要
			isShowBox: true, //是否显示图形外观，默认true,非必要
		});
	}

	//根据id隐藏
	function hide(id) {
		TKBimSdk.Classification.hide({
			id: id, //空间信息id
			floor: 1, //要显示第几层,默认1,非必要
		});
	}

	//移除所有空间标注
	function removeAll() {
		TKBimSdk.Classification.removeAll();
		TKBimSdk.Classification.removeClickCallback();

		for (let index = 0; index < classificationData.length; index++) {
			$("#_" + classificationData[index].id).remove();
		}

		$("#info").hide();
	}

	//定位到空间标注
	function locationTo(id) {
		TKBimSdk.Classification.locationTo(
			{
				id: id, //空间信息id，必要
				rotate: { heading: 0, pitch: 0 }, //定位后，镜头偏航角和仰俯角，单位：角度,默认0,非必要
				durationTime: 2, //移动到目标坐标所用时间，单位：秒,默认2,非必要
				rangeCoeff: 15, //视距，距目标物体距离，数值越大距离越远,默认3,非必要
			},
			() => {
				console.log("locationTo 完成");
			},
		);
	}

	function classificationClick(data) {
		layer.msg(`点击了空间标注：${data}`, { icon: 6, time: 1000 });
	}

	//空间标注数据
	let classificationData = [
		{
			id: "box", //空间标注id
			type: "box",
			coordinate: { x: -2269410.0241026287, y: 4407767.429670414, z: 3999289.8803951796 }, //立方体中心点坐标
			attrData: {
				name: "立方体示例", //空间标注名称,非必要
				length: 3, //立方体长度,单位：米,默认1,非必要
				width: 3, //立方体宽度,单位：米,默认1,非必要
				height: 3, //立方体高度（层高）,单位：米,默认1,非必要
				heading: 0, //标注的旋转角度,非必要
			},
		},
		{
			id: "ellipse", //空间标注id
			type: "ellipse",
			coordinate: { x: -2269421.661841494, y: 4407761.695472337, z: 3999289.9984842633 }, //椭球中心点坐标
			attrData: {
				name: "椭球示例", //空间标注名称,非必要
				axisRadii: [2, 2, 2],
			},
		},
		{
			id: "polygon", //空间标注id
			type: "polygon",
			// coordinate: { longitude: 117.24249519270747, latitude: 39.080722698745542, altitude: 4 }, /
			coordinates: [
				{ x: -2269395.0460737622, y: 4407766.99552334, z: 3999289.0187163805 },
				{ x: -2269387.5119174067, y: 4407770.862028588, z: 3999289.010191942 },
				{ x: -2269394.3218468465, y: 4407784.056090599, z: 3999270.9120903905 },
				{ x: -2269402.0178436628, y: 4407780.093878696, z: 3999270.9102810994 },
			],
			attrData: {
				name: "多边形示例", //空间标注名称 ,非必要
				height: 6, //高度,单位：米,默认1,非必要
			},
		},
	];

	function randomColor(alpha) {
		alpha = alpha == undefined ? ((Math.random() * 10) / 10).toFixed(1) : alpha;
		alpha = Number(alpha);
		if (isNaN(alpha)) alpha = 1;
		var color = [];
		for (var i = 0; i < 3; i++) {
			color.push(parseInt(Math.random() * 256));
		}
		color.push(alpha);
		return color;
	}

</script>

</html>